<div class="list-container">
  <div class="toolbar">
    <h1>🏗️ Tender Dashboard</h1>
    <span class="spacer"></span>
    <span class="count-badge">{{ totalCount }} tenders</span>
  </div>

  <!-- Filters -->
  <div class="filter-bar">
    <mat-form-field appearance="outline" class="search-field">
      <mat-label>Search title or buyer</mat-label>
      <input matInput [(ngModel)]="searchText" (keyup.enter)="applyFilter()" placeholder="e.g. software, Berlin..." />
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Published from</mat-label>
      <input matInput type="date" [(ngModel)]="dateFrom" />
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Published to</mat-label>
      <input matInput type="date" [(ngModel)]="dateTo" />
    </mat-form-field>

    <button mat-flat-button color="primary" (click)="applyFilter()">
      <mat-icon>filter_list</mat-icon> Filter
    </button>
    <button mat-stroked-button (click)="clearFilter()">
      <mat-icon>clear</mat-icon> Clear
    </button>
  </div>

  <!-- Loading spinner -->
  <div *ngIf="loading" class="spinner-wrap">
    <mat-spinner diameter="40"></mat-spinner>
  </div>

  <!-- Table -->
  <div class="table-wrap" [class.hidden]="loading">
    <table mat-table [dataSource]="tenders" matSort
           [matSortActive]="sortColumn"
           [matSortDirection]="sortAsc ? 'asc' : 'desc'"
           matSortDisableClear
           (matSortChange)="onSortChange($event)"
           class="tender-table">

      <!-- Title -->
      <ng-container matColumnDef="TitleEn">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Title</th>
        <td mat-cell *matCellDef="let t">
          <span [matTooltip]="t.TitleDe" matTooltipShowDelay="500">
            {{ t.TitleEn || t.TitleDe || '—' }}
          </span>
        </td>
      </ng-container>

      <!-- Buyer -->
      <ng-container matColumnDef="BuyerNameEn">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Buyer</th>
        <td mat-cell *matCellDef="let t">
          <a *ngIf="t.BuyerPortalUrl" [href]="t.BuyerPortalUrl" target="_blank" rel="noopener">
            {{ t.BuyerNameEn || t.BuyerName || '—' }}
          </a>
          <span *ngIf="!t.BuyerPortalUrl">{{ t.BuyerNameEn || t.BuyerName || '—' }}</span>
          <small *ngIf="t.BuyerCity" class="muted"> · {{ t.BuyerCity }}</small>
        </td>
      </ng-container>

      <!-- CPV -->
      <ng-container matColumnDef="CpvCode">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>CPV</th>
        <td mat-cell *matCellDef="let t">
          <code *ngIf="t.CpvCode">{{ t.CpvCode }}</code>
          <span *ngIf="!t.CpvCode">—</span>
        </td>
      </ng-container>

      <!-- Value -->
      <ng-container matColumnDef="ValueEuro">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Value</th>
        <td mat-cell *matCellDef="let t" class="align-right">{{ formatValue(t.ValueEuro) }}</td>
      </ng-container>

      <!-- Published -->
      <ng-container matColumnDef="PublicationDate">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Published</th>
        <td mat-cell *matCellDef="let t">{{ t.PublicationDate | date:'dd MMM yyyy' }}</td>
      </ng-container>

      <!-- Deadline -->
      <ng-container matColumnDef="SubmissionDeadline">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Deadline</th>
        <td mat-cell *matCellDef="let t">{{ (t.SubmissionDeadline || t.Deadline) | date:'dd MMM yyyy' }}</td>
      </ng-container>

      <!-- Score -->
      <ng-container matColumnDef="SuitabilityScore">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Score</th>
        <td mat-cell *matCellDef="let t">
          <span *ngIf="t.SuitabilityScore != null" class="score-badge" [ngClass]="scoreClass(t.SuitabilityScore)">
            {{ t.SuitabilityScore }}/10
          </span>
          <span *ngIf="t.SuitabilityScore == null" class="muted">—</span>
        </td>
      </ng-container>

      <!-- Actions -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let t">
          <a mat-icon-button [routerLink]="['/tenders', t.TenderID]" matTooltip="View details">
            <mat-icon>open_in_new</mat-icon>
          </a>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"
          [class.has-flaws]="row.FatalFlaws"
          [routerLink]="['/tenders', row.TenderID]"
          style="cursor:pointer"></tr>
    </table>

    <mat-paginator
      [length]="totalCount"
      [pageSize]="pageSize"
      [pageSizeOptions]="[10, 25, 50, 100]"
      (page)="onPageChange($event)"
      showFirstLastButtons>
    </mat-paginator>
  </div>
</div>

